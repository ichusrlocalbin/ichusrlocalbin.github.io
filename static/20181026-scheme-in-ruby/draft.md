# BI部でイマドキの開発手法を使って内製した話

## TL;DR

* BI部内製でシステムを開発
* SaaSを駆使してCI/CD
* チーミングや運用方法などノウハウをお伝えできれば
* 「こういうのあるよ」、「なんでこうやらなかったの?」というディスカッション、Welcome! (質問して下さい!)

## はじめに

* イマドキかと言われると常識(そもそもPJは2年前)
  * でもこれで社長表彰もらったので案外チョロい!
* 「最新のものを使わずして最高のものを作れるのか?」ということで世の中の常識をお伝えしたいというのが狙い
* 他のPJの話も入ってるけど許して下さい

## 使ったツール

|項番|サービス種別|利用サービス|
|----|-----------|------------|
|1|ソースコードリポジトリ|github|
|2|チケット管理|JIRA|
|3|文書管理|Confluence|
|4|継続的インテグレーション/デリバリツール|travis|
|5|コミュニケーションツール|Slack|
|6|IaaS|AWS|
|7|PaaS|Dokku on AWS|

## 開発システムについて少々

|種別|ツール名|
|----|-----------|
|言語|Ruby|
|APフレームワーク|Ruby on Rails|
|DB|MySQL|
|環境構築|Ansible|
|環境試験|ServerSpec|

## やりたかったこと

### ビジネス/システム

* 継続的デリバリにより価値を向上し続ける
  * 「1行書き換えてリリースするのにどれくらい時間がかかる?」
* ソースコードが、なぜ、いつ、誰が、更新したかを追跡可能にする

### チーム

* リモート開発
* 楽しく開発

## やったこと

### ビジネス/システム

* チケットなしでソースコードを修正しない
* レビューなしでソースコードを反映させない
* 試験なしでソースコードを反映しない
* 試験が通っていない環境をユーザに提供しない
* 常に最新版をユーザに提供する

これらを簡単に導入、簡単に運用できて、(なるべく人手に頼らず)ルールにより強制する。

### チーム

* Slack/botの活用
* 文化の醸成

## 避けたこと

* 人手によるチェック
  * 見逃し、ミスが起きる。ソースコードレビューなど人がやらないといけないことに注力する。
    * ただし、ソースコードレビューも、syntaxなど機械的にチェックできる所は、機械で弾く
  * システム, ルールによって強制する

## 開発フロー(staging環境へのデプロイ)

1. JIRA
2. github comimt
3. stagingブランチへのPR
4. CI(unit - feature test)
5. Slack review
(5.5 UI check on sushiya)
6. merge development
7. deploy staging環境
8. production(ctd)

## レビュー

* 3pt制
* 開発スキル者: 3pt。一発マージ可能。
* 開発初心者: 1pt。3人の :+1: が必要

## paasを使ったUIの確認

* micro paas `dokku` をAWS上に導入
  * t2.mediumインスタンスで4アプリ動作
* paas
  * git pushでアプリが起動
  * ap container, db, OS系はpaasが管理
* #mutexチャネルで利用を宣言
* sushiya

## Infrastructure as Code

### やったこと

* 環境構築をコード化して管理(ansible)
* ソースコードと同様のリビジョン管理
    * コード(環境)が、なぜ、いつ、どのように変更したのかが分かる
* テストも実施(serverspec)
* 構築だけでなく、定期的/作業時に必要な運用手順も
    * DB backup
    * メトリクス取得
    * 監視設定

### 利点

* 自動化: ミスをなくす、効率化
* 壊して良い安心感

## ドキュメントの最新化

* APIの試験が仕様書に
  * 動作確認 = 仕様
* DBのスキーマの自動生成
* 試験報告書の自動生成

## 運用フロー

### 本番環境への反映

1. stagingブランチまでのマージ
2. staging環境での移行
3. prudctionブランチへのPR作成
4. review
5. merge
6. production環境での移行
7. PRへのログの追加

### PRの中身(テンプレート)

* 実施(予定)者, 実施(予定)時刻
* 結果概要: productionでの確認結果
  * NG→切り戻し後、PRを新たに作ってやり直し
* 作業時刻
* 現状のバージョン確認
* 実行するコマンド
* 期待する結果
* 確認手段
* 切り戻し手順
* stagingでの作業ログ

### 大事なこと

* いつでも戻せる安心感
* 必ず二人で実施
  * ヤバいときに「ヤバい」「落ち着け」と言える安心感
* コマンドの自動化
  * stagingでの動作と同じになるはず
* チェックボックス重要
  * 本番時にポチポチ押していく → 漏れがないかの確認
* 確認項目のテンプレート化
  * ミスしたら増える(けどそんなに大変ではない)

## 監視

* Infrastructure as Code
  * 設定をソースコードで管理
* 検証環境, 本番環境、同じ設定内容が保証
* 試験がツラいが一度やれば安心
* Slackの通知で24時間通知
* Twilioの電話APIを使って電話通知(1次担当者→2次担当者→...)をしているPJも...
* serverspec叩けば何が落ちてるか分かる(というか、監視項目でserverspec入れている)

## チーミング

## パトロン

* ~つまらない開発だった~ ~関心を持てなかった~ 他にやりたいPJがあった、ので
* PJのトップであったT本部長(取締役)に人と開発環境を要求
* お客様資産ではない

## リモートワーク

* 品川-幕張
* geekbot(reminderで良い)
* 今ならdiscordがオススメ
* 機器にこだわろう

### ハッカー

* 豪華な面々
  * knjicode, kashimura, daikuro, hayashida, maeda, otsuka, mineyama, sakamoto, watanabe


### デザイナー

* Webページとか

### 良い行いを可視化し、プラスのフィードバックの容易化

## つらかったこと

###  自動試験のツラミ

* 最初は書くだけなのでいいけど
* コードの修正に伴い...
  * 「何ハードコーディングしてんだよ」などのつらみ...

### travis通らないときがある問題

* featureの書き方がムズい(きちんと書いているはずだけど)
* タイミングで何百と試験があると1個はこける
* 時間がかかる
* localでtravis docker立ちあげて、出せるところは出しておくという [yak-shaving](http://0xcc.net/blog/archives/000196.html)

### git

* 習得に時間がかかる
* やらなきゃダメなことはダメ
  * 開発者の常識なので身につけよう
* 今何をしているか理解が重要
  * 本は読もう

###  デザイナーさんとの協業

* HTML/CSSをもらって、目視patchで自分で充てた
  * github使えるっていったんだけど...

## おまけ

###  BIラボのご紹介

## まとめ

### なぜ成功できたか/何が重要か

* 人&人&人
  * 開発者
  * パトロン
* 技術
  * 真摯に向き合う
* 文化
  * ソースを憎んで人を憎まず
* チーム: 心理的安全
  * 健全なdisり(人でなく行為を)

## 参考書籍

* レゴレス
* Team Geek
* リーダブルコード
* リファクタリング(2nd Editionが出るらしい)
* Gitの本(オススメはよく分からない...)


------------------------------------

## 書くことの項目案

* チケット管理
* レビュー
  * 3pts
* CI
* CD
* slack
* sushiya
  * UIの確認
* 監視
* 運用
  * いつでも戻せることが重要
    * code, DB
* 文化
  * ++
  * 月1で商品
* チーム
  * デザイナー
* APIの試験が文章に
* パトロン
  * 高間さん
  * 人、ツール
* リモート
  * 品川-幕張
  * geekbot(reminderで良い)
  * discordがオススメ
* SGK
  * デモとか
  * 最近作ったツール
  * websocketはってる間、そのIPからのアクセスを許可
* ちゃんとやらなかったよ
  * パスワード(sshの鍵)管理
* つらかったこと
  * 自動試験
  * git
    * 常識なんで身につけよう
    * 本は読もう
* おまけ
  * BIラボのご紹介
* 何が重要か
  * 人&人&人
  * 文化: ソースを憎んで人を憎まず
  * 心理的安全
    * 健全なdisり(人でなく行為を)
* 参考書籍
  * レゴレス
  * Team Geek
  * リーダブルコード
  * リファクタリング(2nd Editionが出るらしい)
  * Gitの本(オススメはよく分からない...)

